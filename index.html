<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ByteShalaDrop - Ultra Fast P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- PeerJS Library: No Firebase needed -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');

        :root { font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #020617; color: #f8fafc; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }

        .mesh-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(at 0% 0%, rgba(34, 197, 94, 0.15) 0, transparent 50%),
                        radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.15) 0, transparent 50%);
            filter: blur(80px);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .pin-input {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .pin-input:focus {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">
    <div class="mesh-bg"></div>

    <header class="fixed top-0 w-full p-4 sm:p-8 flex justify-between items-center z-50 bg-slate-950/50 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="bg-green-500 p-2 rounded-lg shadow-lg shadow-green-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 20v-8m0 0V4m0 8h8m-8 0H4"/></svg>
            </div>
            <div>
                <h1 class="text-lg font-black text-white leading-none">ByteShala<span class="text-green-500">Drop</span></h1>
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Ultra-Fast P2P</p>
            </div>
        </div>
        <div id="status-badge" class="glass-panel px-3 py-1.5 rounded-full flex items-center gap-2">
            <div id="status-dot" class="w-2 h-2 bg-slate-600 rounded-full"></div>
            <span id="status-text" class="text-[9px] font-bold uppercase text-slate-400">Initializing...</span>
        </div>
    </header>

    <main id="main-content" class="w-full max-w-lg mt-24 mb-24">
        <div id="discovery-view" class="space-y-6">
            <div class="glass-panel p-8 rounded-[2.5rem] text-center space-y-4">
                <div class="flex flex-col items-center gap-2">
                    <p class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Your Device PIN</p>
                    <h2 id="my-pin-display" class="text-5xl font-black text-green-500 tracking-tighter">....</h2>
                </div>
                <div class="pt-4 border-t border-white/5">
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Share this PIN to receive files</p>
                </div>
            </div>

            <div class="glass-panel p-8 rounded-[2.5rem] space-y-6">
                <div class="text-center">
                    <h3 class="text-lg font-black text-white">Connect to Peer</h3>
                    <p class="text-xs text-slate-400">Enter the 4-digit PIN of the receiver.</p>
                </div>
                
                <div class="flex justify-center gap-3">
                    <input type="text" maxlength="1" inputmode="numeric" class="pin-input w-14 h-16 rounded-2xl text-center text-3xl font-black text-white" id="p1">
                    <input type="text" maxlength="1" inputmode="numeric" class="pin-input w-14 h-16 rounded-2xl text-center text-3xl font-black text-white" id="p2">
                    <input type="text" maxlength="1" inputmode="numeric" class="pin-input w-14 h-16 rounded-2xl text-center text-3xl font-black text-white" id="p3">
                    <input type="text" maxlength="1" inputmode="numeric" class="pin-input w-14 h-16 rounded-2xl text-center text-3xl font-black text-white" id="p4">
                </div>

                <button id="connect-btn" class="w-full bg-green-500 text-black font-black py-5 rounded-2xl hover:bg-green-400 transition-all shadow-lg shadow-green-500/20">Connect & Send</button>
            </div>
        </div>
    </main>

    <div id="transfer-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/95 backdrop-blur-xl">
        <div class="w-full max-w-md glass-panel rounded-[3rem] p-10 text-center">
            <div class="w-16 h-16 bg-green-500/20 text-green-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            </div>
            <h2 id="modal-title" class="text-2xl font-black text-white mb-6">Connected</h2>
            
            <div id="progress-box" class="hidden mb-8 space-y-3">
                <div class="flex justify-between text-[10px] font-black uppercase text-slate-400">
                    <span id="transfer-status">Transferring...</span>
                    <span id="progress-val">0%</span>
                </div>
                <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-green-500 w-0 transition-all"></div>
                </div>
            </div>

            <button id="send-btn" class="w-full bg-white text-black font-black py-5 rounded-2xl hover:bg-slate-100 transition-all mb-4">Select Files</button>
            <button onclick="location.reload()" class="text-xs font-bold text-red-400 uppercase tracking-widest">Disconnect</button>
        </div>
    </div>

    <input type="file" id="file-input" class="hidden">

    <script>
        const myPin = Math.floor(1000 + Math.random() * 8999).toString();
        const peer = new Peer(`bs-drop-${myPin}`);
        let activeConn = null;

        peer.on('open', (id) => {
            $('#my-pin-display').text(myPin);
            updateStatus('Ready', 'bg-green-500');
        });

        peer.on('connection', (conn) => {
            setupConnection(conn);
        });

        $('#connect-btn').on('click', () => {
            const enteredPin = $('#p1').val() + $('#p2').val() + $('#p3').val() + $('#p4').val();
            if(enteredPin.length !== 4) return;
            
            updateStatus('Connecting...', 'bg-yellow-500');
            const conn = peer.connect(`bs-drop-${enteredPin}`, {
                reliable: true
            });
            
            conn.on('open', () => {
                setupConnection(conn);
            });

            conn.on('error', (err) => {
                alert("Could not find that device. Make sure it's open.");
                updateStatus('Error', 'bg-red-500');
            });
        });

        function setupConnection(conn) {
            activeConn = conn;
            $('#transfer-modal').removeClass('hidden');
            $('#modal-title').text('Connected to ' + conn.peer.replace('bs-drop-', ''));
            updateStatus('Session Active', 'bg-blue-500');

            conn.on('data', (data) => {
                if (data.type === 'file-meta') {
                    window.incomingMeta = data;
                    window.receivedChunks = [];
                    window.receivedSize = 0;
                    showProgress(true, 'Receiving ' + data.name);
                } else if (data.type === 'file-chunk') {
                    window.receivedChunks.push(data.chunk);
                    window.receivedSize += data.chunk.byteLength;
                    
                    const progress = Math.floor((window.receivedSize / window.incomingMeta.size) * 100);
                    updateProgressUI(progress);

                    if (window.receivedSize >= window.incomingMeta.size) {
                        const blob = new Blob(window.receivedChunks);
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = window.incomingMeta.name;
                        a.click();
                        showProgress(false);
                        updateStatus('Saved!', 'bg-green-500');
                        window.receivedChunks = []; // Clear memory
                    }
                }
            });
        }

        $('#send-btn').on('click', () => $('#file-input').click());

        $('#file-input').on('change', function(e) {
            const file = e.target.files[0];
            if (!file || !activeConn) return;

            activeConn.send({
                type: 'file-meta',
                name: file.name,
                size: file.size
            });

            showProgress(true, 'Optimizing Path...');
            
            // ULTRA FAST SETTINGS:
            // 1. Larger Chunk Size (256KB instead of 16KB)
            // 2. High-speed buffer management
            const CHUNK_SIZE = 256 * 1024; 
            const BUFFER_THRESHOLD = 2 * 1024 * 1024; // 2MB threshold
            let offset = 0;

            const sendNextChunk = () => {
                // Flow control: If PeerJS buffer is too full, wait a bit
                // This prevents browser crashes and data loss while maintaining peak speed
                if (activeConn.dataChannel.bufferedAmount > BUFFER_THRESHOLD) {
                    setTimeout(sendNextChunk, 10);
                    return;
                }

                while (offset < file.size && activeConn.dataChannel.bufferedAmount < BUFFER_THRESHOLD) {
                    const slice = file.slice(offset, offset + CHUNK_SIZE);
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        activeConn.send({
                            type: 'file-chunk',
                            chunk: event.target.result
                        });
                        offset += event.target.result.byteLength;
                        updateProgressUI(Math.floor((offset / file.size) * 100));
                        
                        if (offset >= file.size) {
                            setTimeout(() => showProgress(false), 500);
                            updateStatus('Sent!', 'bg-green-500');
                        } else {
                            // Recursively call for next chunk
                            sendNextChunk();
                        }
                    };
                    reader.readAsArrayBuffer(slice);
                    return; // Exit loop to wait for file read
                }
            };
            
            sendNextChunk();
        });

        $('.pin-input').on('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length === 1) $(this).next('.pin-input').focus();
        }).on('keydown', function(e) {
            if(e.key === 'Backspace' && this.value === '') $(this).prev('.pin-input').focus();
        });

        function updateProgressUI(p) {
            $('#progress-bar').css('width', p + '%');
            $('#progress-val').text(p + '%');
        }

        function showProgress(show, txt) {
            if(show) { $('#progress-box').removeClass('hidden'); $('#transfer-status').text(txt); }
            else { $('#progress-box').addClass('hidden'); }
        }

        function updateStatus(txt, color) {
            $('#status-text').text(txt);
            $('#status-dot').attr('class', `w-2 h-2 rounded-full ${color}`);
        }
    </script>
</body>
</html>
